---
name: Build all tools & deploy to Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write


jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: {submodules: recursive}

      # 放在 Install Clang/LLVM 步骤之前
      - name: 安装 LLVM 20
        run: |
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
          echo "deb http://apt.llvm.org/$(lsb_release -cs)/ llvm-toolchain-$(lsb_release -cs)-20 main" | sudo tee /etc/apt/sources.list.d/llvm.list
          sudo apt-get update
          sudo apt-get install -y clang-20 llvm-20 llvm-20-dev cmake ninja-build
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-20 100
          sudo update-alternatives --install /usr/bin/llvm-config llvm-config /usr/bin/llvm-config-20 100

      # 1. CppInsights --------------------------
      - name: Install Clang/LLVM
        run: sudo apt-get update && sudo apt-get install -y cmake ninja-build
      - name: Build CppInsights static web
        working-directory: tools/cppinsights   # 等价于 cd tools/cppinsights
        run: |
          llvm-config --version
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DINSIGHTS_STATIC=ON
          cmake --build build --target insights-html
          mkdir -p ../../public/cppinsights
          cp -r build/insights/html/* ../../public/cppinsights/

      # 2. Perfetto UI --------------------------
      - uses: actions/setup-node@v4
        with: {node-version: 20, cache: 'npm', cache-dependency-path: tools/perfetto/ui/package-lock.json}
      - name: Build Perfetto UI
        working-directory: tools/perfetto/ui
        run: |
          npm ci && npm run build
          mkdir -p ../../public/perfetto
          cp -r dist/* ../../public/perfetto/

      # 3. Compiler Explorer (godbolt) --------
      - uses: actions/setup-node@v4
        with: {node-version: 20, cache: 'npm', cache-dependency-path: tools/compiler-explorer/package-lock.json}
      - name: Build Compiler Explorer
        working-directory: tools/compiler-explorer
        run: |
          npm ci && npm run webpack
          mkdir -p ../public/godbolt
          cp -r out/dist/* ../public/godbolt/

      # 4. 导航页 ------------------------------
      - name: Create public dir & copy site
        run: |
          mkdir -p public
          cp -r site/* public/

      # 5. 上传 Pages 产物 ----------------------
      - uses: actions/upload-pages-artifact@v3
        with: {path: public}
