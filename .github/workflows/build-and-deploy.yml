name: Build all tools & deploy to Pages

on:
  push:
    branches: [main]
  workflow_dispatch:   # 手动触发按钮

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: {submodules: recursive}

      # 1. CppInsights --------------------------
      - name: Install Clang/LLVM
        run: sudo apt-get update && sudo apt-get install -y clang llvm cmake ninja-build
      - name: Build CppInsights static web
        run: |
          cmake -B tools/cppinsights/build -G Ninja -DCMAKE_BUILD_TYPE=Release -DINSIGHTS_STATIC=ON
          cmake --build tools/cppinsights/build --target web
          mkdir -p public/cppinsights
          cp -r tools/cppinsights/build/web/* public/cppinsights/

      # 2. Perfetto UI --------------------------
      - uses: actions/setup-node@v4
        with: {node-version: 20, cache: 'npm', cache-dependency-path: tools/perfetto/ui/package-lock.json}
      - name: Build Perfetto UI
        run: |
          cd tools/perfetto/ui && npm ci && npm run build
          mkdir -p ../../public/perfetto
          cp -r dist/* ../../public/perfetto/

      # 3. Compiler Explorer (godbolt) --------
      - uses: actions/setup-node@v4
        with: {node-version: 20, cache: 'npm', cache-dependency-path: tools/compiler-explorer/package-lock.json}
      - name: Build Compiler Explorer
        run: |
          cd tools/compiler-explorer
          npm ci && npm run webpack
          mkdir -p ../public/godbolt
          cp -r out/dist/* ../public/godbolt/

      # 6. 导航页 ------------------------------
      - name: Copy navigation page
        run: cp -r site/* public/

      # 7. 上传 Pages 产物 ----------------------
      - uses: actions/upload-pages-artifact@v3
        with: {path: public}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
